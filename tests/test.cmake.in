execute_process(COMMAND $ENV{PCSX2} -batch -elf @CMAKE_BINARY_DIR@/@TEST@.elf OUTPUT_FILE @TEST@.actual RESULT_VARIABLE res_var)
if(NOT "${res_var}" STREQUAL "0")
    message(FATAL_ERROR "Failed to run PCSX2 for test @TEST@. Is $PCSX2 set?")
endif()

execute_process(COMMAND @CMAKE_CURRENT_SOURCE_DIR@/../filter.pl @TEST@.actual @TEST@.filtered RESULT_VARIABLE res_var)
if(NOT "${res_var}" STREQUAL "0")
    message(FATAL_ERROR "Failed to filter PCSX2 log for test @TEST@. Is perl installed? Code ${res_var}")
endif()

execute_process(COMMAND ${CMAKE_COMMAND} -E compare_files --ignore-eol @TEST@.filtered @TEST_BASE_DIR@/@TEST@/@TEST@.expected RESULT_VARIABLE res_var)
if(res_var EQUAL 0)
    message("Test @TEST@ passed.")
else()
    # Handle file comparison failure here
    message(@TEST_BASE_DIR@)
    message(FATAL_ERROR "Comparison failed for test @TEST@. ${res_var}")
endif()
